#!/bin/sh

if [ -e /tmp/is_shutdown ]; then
	echo ' off' | flock -x -n /run/lock/feedback1.lock si2c-charwrite-legacy 21 20 0 5
else
	echo ' avg' | flock -x -n /run/lock/feedback1.lock si2c-charwrite-legacy 21 20 0 5
fi

(
for i in 0 20 40; do
	PWR=$(printf "%4.f" "$(cat /srv/www/flukso/30)")
	if [ "${PWR}" -le 0 ]; then
		PWR='--------        '
	elif [ "${PWR}" -gt 9999 ]; then
		PWR='9999    '
	fi

	echo "${PWR}" | flock -x -n /run/lock/feedback1.lock si2c-charwrite-legacy 21 20 0 4 || exit 0

	sleep 20
done
) &
