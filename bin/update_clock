#!/bin/sh

CLOCKFILE="$1"
CLOCKMODE="$(cat "$CLOCKFILE")"

propagate() {
	if [ "$2" = donationprint ]; then
		echo "charwritelolwat\n$1" | nc -w 1 donationprint 1337
	else
		echo "$1" | flock -n /tmp/avrshift.lock si2c-charwrite 8 11 "$2" "$3"
	fi
}

case "${CLOCKMODE}" in
	blank)
		propagate '      ' "$2" "$3"
	;;
	date)
		propagate "$(date '+%d.%m.%y')" "$2" "$3"
	;;
	clock)
		propagate "$(date '+ %H %M %H .%M')" "$2" "$3"
	;;
	hosts)
		GUESTS="$(curl -s -m 4 http://feedback/bgdata/hosts_dynamic)"
		OHOSTS="$(curl -s -m 4 http://feedback/bgdata/hosts_total)"
		propagate $(printf "dhcpdhcp%04d%04d%04d%04d%04d%04d\n" "${OHOSTS}" "${OHOSTS}" "${OHOSTS}" "${GUESTS}" "${GUESTS}" "${GUESTS}") "$2" "$3"
	;;
	power)
		(
		for i in 0 5 10 15 20 25 30 35 40 45 50; do
			PWR=$(printf "%6.f" "$(cat /srv/www/flukso/30)")
			if [ "${PWR}" -le 0 ]; then
				PWR='------------            '
			fi

			# The clock mode may be set to something else while we are in
			# this loop. Therefore, always check if we really should
			# update the power consumption.
			if [ "$(cat "$CLOCKFILE")" = power ]; then
				propagate "${PWR}" "$2" "$3"
			fi
			sleep 5
		done
		) &
		sleep 2
	;;
	*)
		propagate "${CLOCKMODE}" "$2" "$3"
	;;
esac

