#!/bin/sh

CLOCKMODE="$1"

propagate() {
	if [ "$2" = donationprint ]; then
		echo "charwritelolwat\n$1" | nc donationprint 1337
	else
		echo "$1" | flock -n /tmp/avrshift.lock /usr/local/bin/si2c-charwrite 8 11 "$2" "$3"
	fi
}

case "${CLOCKMODE}" in
	date)
		propagate "$(date '+%d.%m.')" "$2" "$3"
	;;
	clock)
		propagate "$(date '+%H%M%H.%M')" "$2" "$3"
	;;
	hosts)
		GUESTS="$(curl -s -m 4 http://feedback/stored.online_guests)"
		OHOSTS="$(curl -s -m 4 http://feedback/stored.online_hosts)"
		propagate $(printf "dhcpdhcp%04d%04d%04d%04d%04d%04d\n" "${OHOSTS}" "${OHOSTS}" "${OHOSTS}" "${GUESTS}" "${GUESTS}" "${GUESTS}") "$2" "$3"
	;;
	power)
		(
		for i in 0 20 40; do
			PWR=$(printf "%4d" "$(cat /srv/www/flukso/60)")
			if [ "${PWR}" -gt 9999 ]; then
				PWR=9999
			fi
			propagate "${PWR}" "$2" "$3"
			sleep 18
		done
		) &
		sleep 2
	;;
	*)
		propagate "${CLOCKMODE}" "$2" "$3"
	;;
esac

