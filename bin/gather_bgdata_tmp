#!/usr/bin/env perl

use strict;
use warnings;
use 5.010;

use File::Slurp qw(write_file);
use List::Util qw(sum);
use LWP::UserAgent;

our $VERSION = '0.01';

my $ua = LWP::UserAgent->new;
$ua->timeout(5);

sub spew {
	my ( $file, $value ) = @_;

	return write_file( $file, { err_mode => 'quiet' }, "${value}\n" );
}

spew( '/tmp/feedback3/9', 1 );
system( 'dorfmap_set_remote', 'feedback3' );

sleep(7);

my @temps;
my @brightness;

for my $i ( 0 .. 12 ) {
	my $res = $ua->get('http://172.22.26.14/?uled=on');

	if ( $res->is_success ) {
		my $data = $res->content;
		my ( $temp, $lsb ) = ( $data =~ m{ temph = (\d+) \n templ = (\d+) }x );
		my ($brightness) = ( $data =~ m{ brightness = (\d+) \n }x );
		if ( $lsb > 127 ) {
			$temp += 0.5;
		}
		push( @temps,      $temp );
		push( @brightness, $brightness );
	}

	sleep(1);
}

if (@temps) {
	my $temp       = sum(@temps) / @temps;
	my $brightness = sum(@brightness) / @brightness;

	spew( '/srv/www/bgdata/lounge_screen_temp',       $temp );
	spew( '/srv/www/bgdata/lounge_screen_brightness', $brightness );
}

spew( '/tmp/feedback3/9', 0 );
system( 'dorfmap_set_remote', 'feedback3' );
